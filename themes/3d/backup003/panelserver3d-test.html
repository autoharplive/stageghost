<!DOCTYPE html>
<html>
  <head>
    <meta charset=utf-8>
		<title>Three.js app</title>
		<style>
			body { margin: 0; }
			canvas { width: 100%; height: 100% }
		</style>
	</head>
	<body>
	  <!-- Include Three.js and other tools -->
		<script type="text/javascript" src="three.js"></script>
		<script type="text/javascript" src="Tween.js"></script>		
		<script>

      // Globals
      // -----------------------------------------
      // Old-style cam pos
      var fCamX = 0; var fCamY = 0; var fCamZ = 3;
      var fCamGoX = 0.5; var fCamGoY = 1; var fCamGoZ = 2;
      var fCamRange = 7.0;
      // New-style cam pos
      var oCamPos = { x : 0, y : 0, z : 1.5 };
      var oCamGo = { x : -0.5, y : 1.2, z: 3.0 };
      var fRotRateX = 0.008; var fRotRateY = 0.013;
      var oLookAt = new THREE.Vector3(0,0,0);
      var fCamTime = 7000;   // Tween time ms larger is slower
      // Objects
      var scene, renderer, camera, boxGeom, flatGeom;
      var oPlants = [];    // Array of plants
      var iPlantCount = 9; // How many plants      
      // Texture files/urls
      var boxTex;
      var sTextures = (
          "http://pbs.twimg.com/profile_images/3533788981/e3d2eaad5f1a0f7c64ca104baa8105ae_400x400.jpeg",
          "assets/fg-foliage-001-white.png"          
      );
      
      // Seedable PRNG
      //Webkit2's crazy invertible mapping generator
      // var seed = 1234;
      var fnRand = (function() {
        var max = Math.pow(2, 32),
            seed;
        return {
          setSeed : function(val) {
            seed = val || Math.round(Math.random() * max);
          },
          getSeed : function() {
            return seed;
          },
          random : function() {
            // creates randomness...somehow...
            seed += (seed * seed) | 5;
            // Shift off bits, discard sign. Discard is
            // important, OR w/ 5 can give us + or - numbers.
            return (seed >>> 32) / max;
          }
        };
      }());
      
		  // Setup
		  function fnInit() {
        // Event listener resizes renderer with browser
        window.addEventListener ('resize', function() {
          var WIDTH = window.innerWidth,
              HEIGHT = window.innerHeight;
          renderer.setSize(WIDTH, HEIGHT);
          // renderer.setClearColor(0x3399ff); // BG if desired 
          camera.aspect = WIDTH / HEIGHT;
          camera.updateProjectionMatrix();
        });  // End listener		  
      }      // End function
      
      // Function: Render called on frame update
		  function render() {
		  
		    requestAnimationFrame (render);     // Req frame update
        // cube.rotation.x += fRotRateX;    // Ex: move stuff
        // cube.rotation.y += fRotRateY;
		    // Update wandering camera
        fnCameraAnim();
        // fnTextureAnim();
		    renderer.render (scene, camera);    // Update
		  }
		  
      // DISUSED: Model loader
      // Load Blender-exported ThreeJS file
      function fnLoadModel() {
        // Load in the mesh and add it to the scene.
        var loader = new THREE.JSONLoader();
        loader.load( "models/BLENDEREXPORTMODEL.js", 
          function (geometry) {
            var material = 
              new THREE.MeshLambertMaterial({color: 0x55B663});
            mesh = new THREE.Mesh(geometry, material);
            scene.add(mesh);
          }
        );  // End loader
      }     // End function
 
      // Texture animations
      function fnTextureAnim() {
        // textureCanvas.offset.set(textureOffset += .001,0);
        oBoxTex.offset.set (Math.random());
      }
 
      // Camera: Update camera tween,
      // or start a random tween if inactive
      function fnCameraAnim() {      
        // Update tween if cam not at cam go
        if (camera.position != oCamGo) {
          TWEEN.update();
          return;         // Done here, shunt
        }
      }
      
      function fnCameraRand() { 
        // No cam tween active, set new target
        oCamGo.x = Math.random() * fCamRange - fCamRange / 2;
        oCamGo.y = Math.random() * fCamRange / 8; // Limit altitude
        oCamGo.z = 1.25 + Math.random() * fCamRange / 3; // Limit Z

        oCamPos = camera.position;
        // Do NOT reinstantiate Tween:
        oTween = new TWEEN.Tween(oCamPos).to(oCamGo, fCamTime); 
        // Hook tween callback to position update
        oTween.onUpdate(function(){
          camera.position.x = oCamPos.x;
          camera.position.y = oCamPos.y;
          camera.position.z = oCamPos.z;
          camera.lookAt (oLookAt);  // Stick look at
        });
        oTween.onComplete(function(){
          fnCameraRand();            // On tween finished
        });
        
        oTween.start();  // Need this?
      }   // End function
 
      // Mainline
      // -----------------------------------------      
      fnInit();     // Move setup below to this
      
		  // Set up 3d scene - note cam parm 0 is focal len
		  scene = new THREE.Scene();
		  camera = 
        new THREE.PerspectiveCamera (
          55, window.innerWidth/window.innerHeight, 0.1, 1000
        );
		  camera.position = oCamPos; 
        
      // Set up render/page, add the scene to dom
		  renderer = new THREE.WebGLRenderer();
		  renderer.setSize (window.innerWidth, window.innerHeight);
		  document.body.appendChild (renderer.domElement);

		  // Object: Ground, a flat plane w/simple texture
		  var oGroundMat = 
        new THREE.MeshBasicMaterial ({color: 0x301a00});
		  var oGround = 
        new THREE.Mesh (
          new THREE.PlaneGeometry (32, 32), oGroundMat);
		  oGround.doubleSided = false;
		  oGround.rotation.x =  - Math.PI / 2;
      oGround.position.y = -0.5;
      scene.add (oGround);		  
		  		  
		  // Object: Box with image texture
		  boxGeom = new THREE.BoxGeometry (1, 1, 1);
		  boxTex = THREE.ImageUtils.loadTexture(
        "assets/boxtexture.jpg");
      boxTex.needsUpdate = true;
      var boxMat = new THREE.MeshBasicMaterial({map: boxTex});
		  var cube = new THREE.Mesh (boxGeom, boxMat);
      scene.add (cube); 
      
      // New seedable prng 
      fnRand.setSeed (1518);
      // Random plant density
      
      // New: Array of foliage, as boxes
 		  var oPlantGeom = new THREE.BoxGeometry (1.5, 1.25, 0.001);
      var oPlantTex = THREE.ImageUtils.loadTexture 
        ("assets/fg-foliage-002-white.png");
      var oPlantTexAlt = THREE.ImageUtils.loadTexture 
        ("assets/pbjellytime.gif");
         // ("assets/fg-foliage-001-white.png");
         // ("https://pbs.twimg.com/profile_images/3533788981/e3d2eaad5f1a0f7c64ca104baa8105ae_400x400.jpeg");
          // ("http://pngimg.com/upload/grass_PNG395.png");          
          // ("http://tools.lr-port.de/flashapps/windkraft/styles/img/gras.png");
          // sTextures[1]);

      // New array of textures?
      // var oPlantTexture = [];
      // oPlantTexture[0] = THREE.ImageUtils.loadText ( // NEW
      //  "assets/fg-foliage-002-white.png");
      //oPlantTexture[1] = THREE.ImageUtils.loadText ( // NEW
      //  "assets/fg-foliage-002-white.png");

      var oPlantMaterial;  // Set basic plant material
      oPlantMaterial = new THREE.MeshBasicMaterial({
        map: oPlantTexAlt,
        transparent: true, // For alpha ch
        opacity: 1.0,      // lt 1 also cool 
        color: 0x559900    // 0x005100    // q: how set no color?         
      });

      for (var i=0; i < iPlantCount; i++) {
        // Try to randomize plant mat-to-tex mapping?
        oPlantMaterial.opacity = 0.75 + Math.random() * 0.25;
        // if (Math.random() * 2 < 1) { 
        //   oPlantMaterial.map = oPlantTexAlt;
        // }
        
        // Create object, with texture/random pos/rotation
        // oPlants[i] = new THREE.Mesh (oPlantGeom, oPlantMat);
        oPlants[i] = new THREE.Mesh (oPlantGeom, oPlantMaterial);        
        oPlants[i].position.x = Math.random() * 6 - 3;
        // oPlants[i].position.x = fnRand.random() / 32 * 16; 
        oPlants[i].position.z = Math.random() * 6 - 3;
        oPlants[i].rotation.y = - Math.PI / Math.random() * 2;        
        // Add it to the scene
        scene.add (oPlants[i]);
      }
		  
      // TWeen setups
      var oTween = new TWEEN.Tween(oCamPos).to(oCamGo, fCamTime);
      var oTween;       // Instantiated in fnCameraRand
      fnCameraRand();   // Starts/restarts random tweens

      // Start renderer
		  render();              // Repeats on clock

		</script>
	</body>
</html>
