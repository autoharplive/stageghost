#!/usr/bin/perl
# Sample 'door game' for StageGhost/DTV 12xx2016 @garyd
# Caller: Append user channelid to args, it is popped off first
# Reset the game:  box reset 
# Provide help  :  box help 
# Tease/attract user if eligible to open box
#                  box tease UserChannelID
# Open the box:    box open UserChannelID
# Reseal w/spider: box spider UserChannelID
# Reseal w/candy:  box candy UserChannelID
# Reseal w/easter egg "dead spider and an empty wrapper wtf"
#                  box joke UserChannelID

# Mostly hardwired datafiles (note: may need to truncate usernames)
my $Game = "door_box";                   # relative path
my $Players = `cat $Game/players.txt`;   # recent player ids
my $Contents = `cat $Game/contents.txt`; # contents of box
my $Attacker = `cat $Game/attacker.txt`; # who last closed box
my $Help     = `cat $Game/help.txt`;     # response to help command
my $Log      = "$Game/log.txt";          # for writing

# To do: use only if X minutes fresh
# else consider box closed by default
my $Victim = `cat $Game/victim.txt`;     # active opener, if recent

# Main
# -----------------------
# Assume default 'tease' arg user ch id, else programmer error
my $UserCh = pop (@ARGV);  # Pop off bottom
my $Cmd = shift (@ARGV); 
$Cmd = "tease" unless ($Cmd);
unless ($Cmd && $UserCh) {
  die ("\n$0 usage: ".`head -11 $0`."\n");  # Spit out header, shunt
}  

# Get the player's name for text messages
my $UserName = `./ytUserInfo $UserCh`;

# Tease: If player eligible, offer them the box (or end)
if ($Cmd eq "tease") {
  fnTease();
  exit(0);  # done here
}

# Handle help (beware fuzzy match)
if ($Cmd =~ /^h/) {
  print ("$Help");      # Simply respond with help file to chat  
  exit(0);
}

# Open the box (again fuzzy match)
if ($Cmd =~ /^o/) {
  exit(0);
}

# Fin

# Handle teasing
# -----------------------
sub fnTease {
  if ($Players =~ /$UserCh/gsio) {
    # Ineligible, shunt w/log
    fnLog ("$0: Player $UserCh ineligible because in $Game/players.txt");
    exit(0);
  }

  if ($Victim =~ $UserCh) {
    # Somehow we're about to tease current victim - don't
    fnLog ("$0: Not teasing current victim cause thats dumb.");
    exit(0);
  }

  # All good to tease
  fnLog ("$0: Teasing $UserCh because tease command");

  # Output attract msg directly to stdio, bot sends it to chat
  print ("Psst! Hey $UserName, there is a box here, sealed by $Attacker. Want to open it? Type BOX HELP for info.");

}

# Simple logger
# -----------------------
sub fnLog {
  my $argMsg = shift (@_);
  open (LOG, ">$Log") or die ("\n$0 fatality: Cant write to $Log");
  print (LOG $argMsg);
  close (LOG);
}
